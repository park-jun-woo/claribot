# Claritask Code Report

**최종 업데이트**: 2026-02-03

## 1. Overview

| Category | Value |
|----------|-------|
| Language | Go 1.21+ |
| CLI Framework | Cobra v1.8.0 |
| Database | SQLite (mattn/go-sqlite3 v1.14.22) |
| YAML Parser | gopkg.in/yaml.v3 |
| Binary Name | `clari` |
| Total Source Files | 29 Go 파일 |
| Total Source Lines | ~7,500 lines |
| Total Test Files | 10 테스트 파일 |
| Total Test Lines | ~3,500 lines |

## 2. Project Structure

```
claritask/
├── cmd/claritask/
│   └── main.go                    # Entry point (13 lines)
├── internal/
│   ├── cmd/                       # CLI commands (~3,200 lines)
│   │   ├── root.go               # Root command, DB/JSON helpers
│   │   ├── init.go               # Project initialization
│   │   ├── project.go            # Project CRUD + execution
│   │   ├── phase.go              # Phase management
│   │   ├── task.go               # Task lifecycle
│   │   ├── memo.go               # Memo operations
│   │   ├── context.go            # Project context
│   │   ├── tech.go               # Tech stack
│   │   ├── design.go             # Design decisions
│   │   ├── required.go           # Required check
│   │   ├── feature.go            # Feature management (NEW)
│   │   ├── edge.go               # Dependency edges (NEW)
│   │   ├── fdl.go                # FDL commands (NEW)
│   │   └── plan.go               # Planning commands (NEW)
│   ├── service/                   # Business logic (~4,200 lines)
│   │   ├── project_service.go    # Project, Context, Tech, Design
│   │   ├── phase_service.go      # Phase lifecycle
│   │   ├── task_service.go       # Task lifecycle, PopTask
│   │   ├── memo_service.go       # Memo operations
│   │   ├── state_service.go      # State management
│   │   ├── feature_service.go    # Feature CRUD, edges (NEW)
│   │   ├── edge_service.go       # Dependency graph (NEW)
│   │   ├── fdl_service.go        # FDL parsing/validation (NEW)
│   │   ├── skeleton_service.go   # Skeleton generation (NEW)
│   │   ├── plan_service.go       # Feature planning (NEW)
│   │   ├── orchestrator_service.go # Execution orchestration (NEW)
│   │   └── debug_service.go      # Interactive debugging (NEW)
│   ├── db/                        # Database layer (193 lines)
│   │   └── db.go
│   └── model/                     # Data models (185 lines)
│       └── models.go
├── scripts/
│   └── skeleton_generator.py      # Python skeleton generator
└── test/                          # Tests (~3,500 lines)
    ├── db_test.go
    ├── models_test.go
    ├── project_service_test.go
    ├── phase_service_test.go
    ├── task_service_test.go
    ├── memo_service_test.go
    ├── state_service_test.go
    ├── feature_service_test.go   # (NEW)
    ├── edge_service_test.go      # (NEW)
    └── fdl_service_test.go       # (NEW)
```

## 3. CLI Commands

### Command Tree

```
clari
├── init <project-id> [description]    # Initialize project
├── project
│   ├── set '<json>'                    # Set project config
│   ├── get                             # Get project info
│   ├── plan                            # Start planning mode
│   ├── start [--feature N] [--dry-run] [--fallback-interactive]
│   ├── stop                            # Stop execution
│   └── status                          # Show execution status
├── phase
│   ├── create '<json>'                 # Create phase
│   ├── list                            # List phases
│   ├── plan <phase_id>                 # Plan phase
│   └── start <phase_id>                # Start phase
├── task
│   ├── push '<json>'                   # Create task
│   ├── pop                             # Get next task (with manifest)
│   ├── start <task_id>                 # Start task
│   ├── complete <task_id> '<json>'     # Complete task
│   ├── fail <task_id> '<json>'         # Fail task
│   ├── status                          # Show progress
│   ├── get <task_id>                   # Get task detail
│   └── list <phase_id>                 # List tasks by phase
├── memo
│   ├── set <key> '<json>'              # Set memo
│   ├── get <key>                       # Get memo
│   ├── list [scope]                    # List memos
│   └── del <key>                       # Delete memo
├── context
│   ├── set '<json>'                    # Set context
│   └── get                             # Get context
├── tech
│   ├── set '<json>'                    # Set tech stack
│   └── get                             # Get tech stack
├── design
│   ├── set '<json>'                    # Set design
│   └── get                             # Get design
├── required                            # Check required fields
├── feature                             # (NEW) Feature management
│   ├── list                            # List features with stats
│   ├── add '<json>'                    # Add feature
│   ├── get <id>                        # Get feature detail
│   ├── spec <id> '<spec>'              # Set feature spec
│   ├── start <id>                      # Start feature execution
│   └── tasks <id> [--generate]         # List/generate tasks
├── edge                                # (NEW) Dependency edges
│   ├── add --from N --to M [--feature] # Add dependency edge
│   ├── list [--feature] [--task] [--phase N]
│   ├── remove --from N --to M [--feature]
│   └── infer --feature N | --project [--min-confidence 0.7]
├── fdl                                 # (NEW) FDL management
│   ├── create <name>                   # Create FDL template
│   ├── register <file>                 # Register FDL as feature
│   ├── validate <feature_id>           # Validate FDL
│   ├── show <feature_id>               # Show FDL content
│   ├── skeleton <feature_id> [--dry-run] [--force]
│   ├── tasks <feature_id>              # Generate tasks from FDL
│   ├── verify <feature_id>             # Verify implementation
│   └── diff <feature_id>               # Show code differences
└── plan                                # (NEW) Planning
    └── features [--auto-create]        # Plan features with LLM
```

## 4. Data Models

### 4.1 Core Models (`internal/model/models.go`)

| Model | Fields | Purpose |
|-------|--------|---------|
| `Project` | ID, Name, Description, Status, CreatedAt | Project metadata |
| `Phase` | ID, ProjectID, Name, Description, OrderNum, Status, CreatedAt | Work phase |
| `Task` | ID, PhaseID, ParentID, Status, Title, Level, Skill, References, Content, Result, Error, **FeatureID, SkeletonID, TargetFile, TargetLine, TargetFunction**, timestamps | Atomic work unit |
| `Feature` | ID, ProjectID, Name, Description, **Spec, FDL, FDLHash, SkeletonGenerated**, Status, CreatedAt | Feature unit (NEW) |
| `FeatureEdge` | FromFeatureID, ToFeatureID, CreatedAt | Feature dependency (NEW) |
| `TaskEdge` | FromTaskID, ToTaskID, CreatedAt | Task dependency (NEW) |
| `Skeleton` | ID, FeatureID, FilePath, Layer, Checksum, CreatedAt | Generated skeleton file (NEW) |
| `Context` | ID(=1), Data(JSON), timestamps | Project context (singleton) |
| `Tech` | ID(=1), Data(JSON), timestamps | Tech stack (singleton) |
| `Design` | ID(=1), Data(JSON), timestamps | Design decisions (singleton) |
| `State` | Key, Value | Runtime state (key-value) |
| `Memo` | Scope, ScopeID, Key, Data(JSON), Priority, timestamps | Scoped notes |

### 4.2 Response Types (NEW)

| Type | Purpose |
|------|---------|
| `Response` | 기본 JSON 응답 (success, error) |
| `MemoData` | 메모 데이터 (JSON 출력용) |
| `FDLInfo` | FDL 정보 (task pop 시 반환) |
| `SkeletonInfo` | 스켈레톤 정보 (file, line, content) |
| `Dependency` | 의존 Task 정보 (id, title, result) |
| `TaskPopResponse` | task pop 전체 응답 (task, fdl, skeleton, deps, manifest) |
| `Manifest` | 컨텍스트 매니페스트 (context, tech, design, feature, state, memos) |

### 4.3 State Flow

```
Task: pending → doing → done/failed
Phase: pending → active → done
Feature: pending → active → done
Project: active → archived
```

## 5. Database Schema

### Tables

| Table | Primary Key | Description |
|-------|-------------|-------------|
| `projects` | id (TEXT) | Project registry |
| `phases` | id (INTEGER AUTO) | Phase with FK to project |
| `features` | id (INTEGER AUTO) | Feature with FK to project (NEW) |
| `feature_edges` | (from_feature_id, to_feature_id) | Feature dependencies (NEW) |
| `skeletons` | id (INTEGER AUTO) | Generated skeleton files (NEW) |
| `tasks` | id (INTEGER AUTO) | Task with FK to phase/feature/skeleton |
| `task_edges` | (from_task_id, to_task_id) | Task dependencies (NEW) |
| `context` | id (CHECK=1) | Singleton context |
| `tech` | id (CHECK=1) | Singleton tech |
| `design` | id (CHECK=1) | Singleton design |
| `state` | key (TEXT) | Key-value store |
| `memos` | (scope, scope_id, key) | Composite PK |

### Foreign Keys
- `phases.project_id` → `projects.id`
- `features.project_id` → `projects.id`
- `feature_edges.from_feature_id` → `features.id`
- `feature_edges.to_feature_id` → `features.id`
- `skeletons.feature_id` → `features.id`
- `tasks.phase_id` → `phases.id`
- `tasks.parent_id` → `tasks.id` (self-reference)
- `tasks.feature_id` → `features.id`
- `tasks.skeleton_id` → `skeletons.id`
- `task_edges.from_task_id` → `tasks.id`
- `task_edges.to_task_id` → `tasks.id`

## 6. Service Layer Analysis (NEW)

### 6.1 Service 파일별 기능

| Service | Lines | 주요 기능 |
|---------|-------|----------|
| `edge_service.go` | 794 | 의존성 그래프 관리, 사이클 감지, 위상 정렬, LLM 추론 |
| `fdl_service.go` | 850 | FDL 파싱/검증, Task 매핑 추출, 구현 검증/차이 |
| `task_service.go` | 634 | Task CRUD, PopTask, PopTaskFull (의존성 기반) |
| `skeleton_service.go` | 422 | 스켈레톤 관리, Python 생성기 연동, TODO 추출 |
| `orchestrator_service.go` | 429 | 실행 상태 관리, Claude 연동 실행 |
| `feature_service.go` | 377 | Feature CRUD, FDL 관리, Edge 관리 |
| `project_service.go` | 336 | Project/Context/Tech/Design 관리 |
| `memo_service.go` | 232 | 메모 CRUD, 스코프 기반 조회 |
| `debug_service.go` | 199 | TTY Handover 인터랙티브 디버깅 |
| `plan_service.go` | 161 | LLM 기반 Feature 기획 |
| `phase_service.go` | 129 | Phase CRUD, 상태 전환 |
| `state_service.go` | 122 | Key-Value 상태 관리 |

### 6.2 Code Quality - Strengths

| Aspect | Details |
|--------|---------|
| **Consistent Structure** | All commands follow same pattern: parse input → open DB → execute → output JSON |
| **Error Handling** | Early return pattern, error wrapping with `fmt.Errorf("context: %w", err)` |
| **JSON Output** | All CLI outputs standardized with `success` field |
| **Separation of Concerns** | Clear layers: cmd (CLI) → service (business logic) → db (persistence) |
| **Dependency Graph** | DFS 사이클 감지, Kahn's algorithm 위상 정렬 |
| **FDL Integration** | 선언적 기능 정의 → 자동 Task/Skeleton 생성 |

### 6.3 Areas for Improvement

| Issue | Location | Suggestion |
|-------|----------|------------|
| **Large file** | `edge_service.go` (794줄) | Task/Feature Edge 분리 |
| **Direct SQL in cmd** | `feature.go:244` | service 레이어로 이동 |
| **Incomplete integration** | `fdl.go:350` | Python 스켈레톤 생성기 연동 완성 필요 |
| **No pagination** | `ListTasks`, `ListPhases` | Add LIMIT/OFFSET for large datasets |

## 7. Test Coverage

| Test File | Coverage Area |
|-----------|---------------|
| `models_test.go` | 모델 구조, JSON 직렬화 |
| `db_test.go` | DB 연결, 마이그레이션, 시간 함수 |
| `project_service_test.go` | Project, Context, Tech, Design CRUD |
| `phase_service_test.go` | Phase CRUD, 상태 변경 |
| `task_service_test.go` | Task CRUD, PopTask, 상태 변경 |
| `memo_service_test.go` | 메모 CRUD, 스코프 |
| `state_service_test.go` | 상태 CRUD |
| `feature_service_test.go` | Feature CRUD, Edge 관리 (NEW) |
| `edge_service_test.go` | 의존성 Edge, 사이클 감지 (NEW) |
| `fdl_service_test.go` | FDL 파싱, 검증 (NEW) |

### Missing Test Coverage
- CLI commands (`internal/cmd/*`)
- Integration tests (end-to-end workflow)
- `skeleton_service.go`, `orchestrator_service.go`, `debug_service.go`

## 8. Key Workflows

### 8.1 Project Initialization (`clari init`)

```
1. Validate project ID (regex: ^[a-z0-9_-]+$)
2. Create directory: ./<project-id>/.claritask/
3. Initialize SQLite DB with schema (12 tables)
4. Create project record
5. Initialize state keys
6. Generate CLAUDE.md template
```

### 8.2 FDL-based Development (NEW)

```
1. clari fdl create user-auth          # FDL 템플릿 생성
2. (FDL 편집)
3. clari fdl register features/user-auth.fdl.yaml  # Feature 등록
4. clari fdl validate 1                # FDL 검증
5. clari fdl skeleton 1                # 스켈레톤 생성
6. clari fdl tasks 1                   # Task 자동 생성 (with edges)
7. clari edge infer --feature 1        # 의존성 추론
8. clari project start --feature 1     # 실행
```

### 8.3 Task Pop with Full Context (`clari task pop`)

```
1. Find next executable task (pending + all deps done)
2. Start task (pending → doing)
3. Build full response:
   - Task details
   - FDL info (if feature associated)
   - Skeleton info (if skeleton associated)
   - Dependency results (completed deps)
   - Manifest (context, tech, design, feature, state, memos)
4. Update current state
5. Start phase if pending
6. Return TaskPopResponse as JSON
```

### 8.4 Dependency-aware Execution

```
           ┌─────────────┐
           │ Model Task  │
           └─────┬───────┘
                 │ depends on
           ┌─────▼───────┐
           │ Service Task│
           └─────┬───────┘
                 │ depends on
           ┌─────▼───────┐
           │  API Task   │
           └─────┬───────┘
                 │ depends on
           ┌─────▼───────┐
           │  UI Task    │
           └─────────────┘

GetNextExecutableTask: 모든 deps가 done인 첫 pending task
TopologicalSortTasks: Kahn's algorithm으로 실행 순서 결정
```

### 8.5 Interactive Debugging (TTY Handover)

```
1. Headless 실행 실패 시
2. RunInteractiveDebugging() 호출
3. Claude 프로세스에 TTY 전달 (stdin/stdout/stderr)
4. 시스템 프롬프트: 테스트 실행 → 분석 → 수정 → 반복
5. 완료 후 검증 (VerifyAfterDebugging)
```

### 8.6 Memo Scope Key Format

| Format | Scope | Example |
|--------|-------|---------|
| `key` | project | `notes` |
| `phase_id:key` | phase | `1:summary` |
| `phase_id:task_id:key` | task | `1:42:blockers` |

## 9. Dependencies

```
github.com/spf13/cobra v1.8.0         # CLI framework
github.com/mattn/go-sqlite3 v1.14.22  # SQLite driver
gopkg.in/yaml.v3                      # YAML parsing (for FDL)
github.com/inconshreveable/mousetrap v1.1.0  # (indirect)
github.com/spf13/pflag v1.0.5         # (indirect)
```

## 10. Build & Install

```bash
# Build and install to $GOBIN or $GOPATH/bin
make install

# Run tests
make test

# Uninstall
make uninstall
```

## 11. FDL (Feature Definition Language) 구조 (NEW)

```yaml
feature: user_auth
description: "사용자 인증 기능"

models:
  - name: User
    table: users
    fields:
      - name: id
        type: uuid
        constraints: pk
      - name: email
        type: string
        constraints: unique

service:
  - name: createUser
    desc: "새 사용자 생성"
    input: {email: string, password: string}
    output: User
    steps:
      - "이메일 중복 확인"
      - "비밀번호 해싱"
      - "사용자 저장"

api:
  - path: /api/users
    method: POST
    use: service.createUser
    response:
      201: {id: uuid}

ui:
  - component: SignupForm
    type: Organism
    state: [email, password, error]
```

## 12. Architecture Diagram

```
┌──────────────────────────────────────────────────────────────┐
│                         CLI Layer                             │
│  init, project, phase, task, memo, feature, edge, fdl, plan  │
└────────────────────────────┬─────────────────────────────────┘
                             │
┌────────────────────────────▼─────────────────────────────────┐
│                       Service Layer                           │
│  project, phase, task, memo, state, feature, edge, fdl,      │
│  skeleton, plan, orchestrator, debug                          │
└────────────────────────────┬─────────────────────────────────┘
                             │
┌────────────────────────────▼─────────────────────────────────┐
│                      Database Layer                           │
│                         SQLite                                │
│  projects, phases, features, feature_edges, skeletons,       │
│  tasks, task_edges, context, tech, design, state, memos      │
└──────────────────────────────────────────────────────────────┘
```

## 13. Recommendations

### Completed (Previously Short-term)
- ~~Implement task dependencies~~ → task_edges 테이블 구현 완료
- ~~TTY handover~~ → debug_service.go 구현 완료

### Short-term
1. Add CLI command tests using `cobra.Command.Execute()` with mock DB
2. Complete Python skeleton generator integration
3. Add tests for skeleton_service, orchestrator_service, debug_service

### Medium-term
1. Add `--format` flag for output (json/table/minimal)
2. Implement `clari undo` for recovering from failed tasks
3. Add real-time progress monitoring (WebSocket?)

### Long-term
1. Add plugin system for custom skills
2. Support remote DB (PostgreSQL) for team collaboration
3. Multi-project workspace support

---

*Generated: 2026-02-03*
*Total Analysis: 39 Go files, ~7,500 source lines, ~3,500 test lines*
