# Claritask 코드 분석 보고서

**분석 일자**: 2026-02-03
**총 파일 수**: 39개 Go 파일
**총 라인 수**: ~8,000줄 이상

---

## 1. 프로젝트 개요

Claritask는 **Claude Code를 위한 장시간 자동 실행 시스템**입니다.

### 핵심 가치
- **Task 기반 실행**: Push/Pop 방식의 작업 큐
- **FDL(Feature Definition Language)**: 선언적 기능 정의
- **의존성 관리**: DAG 기반 실행 순서 결정
- **TTY Handover**: 실패 시 인터랙티브 디버깅

### 기술 스택
- **Language**: Go 1.21+
- **CLI Framework**: Cobra
- **Database**: SQLite (mattn/go-sqlite3)
- **YAML Parser**: gopkg.in/yaml.v3

---

## 2. 아키텍처

```
cmd/claritask/
└── main.go              # 진입점

internal/
├── cmd/                 # Cobra 명령어 (16개)
│   ├── root.go          # 루트 + 유틸리티
│   ├── init.go          # 프로젝트 초기화
│   ├── project.go       # 프로젝트 관리
│   ├── phase.go         # Phase 관리
│   ├── task.go          # Task 관리
│   ├── feature.go       # Feature 관리
│   ├── edge.go          # 의존성 관리
│   ├── fdl.go           # FDL 관리
│   ├── plan.go          # Feature 계획
│   ├── context.go       # 컨텍스트
│   ├── tech.go          # 기술 스택
│   ├── design.go        # 설계 결정
│   ├── required.go      # 필수 입력 확인
│   └── memo.go          # 메모 관리
│
├── db/
│   └── db.go            # SQLite 래퍼, 스키마
│
├── model/
│   └── models.go        # 데이터 모델
│
└── service/             # 비즈니스 로직 (12개)
    ├── project_service.go
    ├── phase_service.go
    ├── task_service.go
    ├── memo_service.go
    ├── state_service.go
    ├── feature_service.go
    ├── edge_service.go
    ├── fdl_service.go
    ├── skeleton_service.go
    ├── plan_service.go
    ├── orchestrator_service.go
    └── debug_service.go
```

---

## 3. 데이터베이스 스키마

### 핵심 테이블 (12개)

| 테이블 | 용도 | PK |
|--------|------|-----|
| `projects` | 프로젝트 | TEXT (사용자 지정) |
| `phases` | 작업 단계 | AUTOINCREMENT |
| `features` | 기능 단위 | AUTOINCREMENT |
| `feature_edges` | Feature 의존성 | (from, to) |
| `tasks` | 실행 단위 | AUTOINCREMENT |
| `task_edges` | Task 의존성 | (from, to) |
| `skeletons` | 스켈레톤 파일 | AUTOINCREMENT |
| `context` | 프로젝트 컨텍스트 | 1 (싱글톤) |
| `tech` | 기술 스택 | 1 (싱글톤) |
| `design` | 설계 결정 | 1 (싱글톤) |
| `state` | Key-Value 상태 | KEY |
| `memos` | 메모 | (scope, scope_id, key) |

### 상태 흐름
```
Task:    pending → doing → done | failed
Phase:   pending → active → done
Feature: pending → active → done
```

---

## 4. 주요 기능

### 4.1 CLI 명령어 구조 (14개 그룹)

```bash
clari init <project-id>          # 프로젝트 초기화
clari project [set|get|plan|start|stop|status]
clari phase [create|list|plan|start]
clari task [push|pop|start|complete|fail|status|get|list]
clari feature [list|add|get|spec|start|tasks]
clari edge [add|list|remove|infer]
clari fdl [create|register|validate|show|skeleton|tasks|verify|diff]
clari plan [features]
clari context [set|get]
clari tech [set|get]
clari design [set|get]
clari required
clari memo [set|get|list|delete]
```

### 4.2 FDL (Feature Definition Language)

YAML 기반 선언적 기능 정의:

```yaml
feature: user_auth
description: User authentication

models:
  - name: User
    table: users
    fields:
      - { name: id, type: uuid, constraints: pk }
      - { name: email, type: string }

service:
  - name: createUser
    input: { email: string, password: string }
    steps:
      - Validate email
      - Hash password
      - Insert user

api:
  - path: /api/users
    method: POST
    use: service.createUser
    response:
      201: { id: uuid }

ui:
  - component: LoginForm
    type: Organism
    state: [email, password]
```

### 4.3 의존성 관리

- **사이클 감지**: DFS 알고리즘
- **위상 정렬**: Kahn's 알고리즘
- **실행 가능 Task**: 모든 의존성 완료된 pending Task

### 4.4 TTY Handover

실패한 Task를 인터랙티브 모드로 디버깅:

```go
cmd := exec.Command("claude",
    "--system-prompt", systemPrompt,
    "--permission-mode", "acceptEdits",
    initialPrompt,
)
cmd.Stdin = os.Stdin
cmd.Stdout = os.Stdout
cmd.Stderr = os.Stderr
cmd.Run()
```

---

## 5. 서비스 레이어 요약

| 서비스 | 라인 수 | 핵심 기능 |
|--------|---------|----------|
| project_service | 336 | Project/Context/Tech/Design CRUD |
| phase_service | 129 | Phase 생명주기 |
| task_service | 634 | Task CRUD, Pop, 상태 관리 |
| memo_service | 232 | 계층적 메모 관리 |
| state_service | 122 | Key-Value 상태 |
| feature_service | 377 | Feature CRUD, Edge 관리 |
| edge_service | 794 | 의존성 그래프, 사이클 감지 |
| fdl_service | 850 | FDL 파싱/검증, Task 매핑 |
| skeleton_service | 422 | 스켈레톤 파일 관리 |
| plan_service | 161 | LLM Feature 계획 |
| orchestrator_service | 429 | 실행 오케스트레이션 |
| debug_service | 199 | TTY Handover 디버깅 |

---

## 6. 테스트 현황

| 테스트 파일 | 대상 |
|------------|------|
| models_test.go | 모델 직렬화 |
| db_test.go | DB 연결/마이그레이션 |
| project_service_test.go | 프로젝트 서비스 |
| phase_service_test.go | Phase 서비스 |
| task_service_test.go | Task 서비스 |
| memo_service_test.go | 메모 서비스 |
| state_service_test.go | 상태 서비스 |
| feature_service_test.go | Feature 서비스 |
| edge_service_test.go | Edge 서비스 |
| fdl_service_test.go | FDL 서비스 |

---

## 7. 개별 리포트 목록

생성된 개별 파일 리포트:

### cmd 리포트
- `main-report.md`
- `cmd-root-report.md`
- `cmd-init-report.md`
- `cmd-project-report.md`
- `cmd-phase-report.md`
- `cmd-task-report.md`
- `cmd-feature-report.md`
- `cmd-edge-report.md`
- `cmd-fdl-report.md`
- `cmd-plan-report.md`
- `cmd-context-report.md`
- `cmd-tech-report.md`
- `cmd-design-report.md`
- `cmd-required-report.md`
- `cmd-memo-report.md`

### db/model 리포트
- `db-report.md`
- `models-report.md`

### service 리포트
- `service-project-report.md`
- `service-phase-report.md`
- `service-task-report.md`
- `service-memo-report.md`
- `service-state-report.md`
- `service-feature-report.md`
- `service-edge-report.md`
- `service-fdl-report.md`
- `service-skeleton-report.md`
- `service-plan-report.md`
- `service-orchestrator-report.md`
- `service-debug-report.md`

### test 리포트
- `test-summary-report.md`

---

## 8. 결론

Claritask는 잘 구조화된 Go CLI 애플리케이션으로:

1. **모듈화**: cmd/service/model/db 계층 분리
2. **일관성**: Cobra 패턴, JSON 출력, 에러 처리
3. **확장성**: FDL 기반 선언적 기능 정의
4. **안정성**: 사이클 감지, 의존성 기반 실행

Claude Code와의 통합을 통해 장시간 자동 실행이 가능한 Task 관리 시스템을 제공합니다.
