# Claribot v0.2 구현 기록 (2026-02-04)

## 완료 작업

### 1. Makefile 및 systemd 서비스 설정

**Makefile 생성** - 주요 타겟:
- `make build` - cli/와 bot/ 빌드
- `make install` - 전체 설치
- `make install-cli` - clari를 /usr/local/bin에 설치
- `make install-bot` - claribot systemd 서비스 등록
- `make uninstall` - 전체 제거
- `make status/restart/logs` - 서비스 관리

**systemd 서비스** (`claribot.service.template`):
- User/WorkingDirectory 자동 설정
- `make install-bot`으로 등록/시작

### 2. DB 스키마 설계 (v0.2 단순화)

**전역 DB** (`~/.claribot/db.clt`):
```sql
projects (id, name, path, description, status, created_at, updated_at)
```

**로컬 DB** (`프로젝트/.claribot/db.clt`):
```sql
tasks (
    id, parent_id, source,  -- parent_id=NULL이면 최상위(=Message)
    title, content, status, result, error,
    created_at, started_at, completed_at
)

task_edges (from_task_id, to_task_id, created_at)
```

**핵심 단순화**: Message를 별도 테이블로 두지 않고 Task로 통합. `parent_id=NULL`이면 최상위 Task(사용자 메시지).

### 3. Telegram 패키지 구현

**bot/pkg/telegram/telegram.go**:
```go
bot, _ := telegram.New(token)
bot.SetHandler(func(msg telegram.Message) {
    bot.Send(msg.ChatID, "Echo: "+msg.Text)
})
bot.Start()
defer bot.Stop()
```

- Message 구조체: ChatID, UserID, Username, Text
- Send, SendMarkdown, Reply 메서드
- Graceful shutdown 지원

### 4. Claribot 메인 연동

**bot/cmd/claribot/main.go** (v0.2.1):
- 설정 파일: `~/.claribot/config.yaml`
- HTTP 서버 (127.0.0.1:9847)
- 텔레그램 봇 연동 (Echo 응답)
- SIGINT/SIGTERM 시그널 핸들링

## 현재 프로젝트 구조

```
claribot/
├── Makefile
├── claribot.service.template
├── bot/
│   ├── cmd/claribot/main.go
│   ├── internal/db/db.go
│   └── pkg/
│       ├── claude/claude.go
│       └── telegram/telegram.go
├── cli/
│   └── cmd/clari/main.go
└── bin/  (빌드 결과물, .gitignore)
```

## 설정 파일

`~/.claribot/config.yaml`:
```yaml
service:
  port: 9847
  host: 127.0.0.1

telegram:
  token: "BOT_TOKEN"
  allowed_users:
    - 123456789

claude:
  timeout: 1200
  max: 3
```

## 다음 단계

1. 텔레그램 메시지 → Task 생성 로직
2. Claude Code TTY 연동
3. Task 실행 및 결과 반환
